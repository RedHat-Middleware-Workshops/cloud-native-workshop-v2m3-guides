== Lab 1 - Creating Distributed Services
:experimental:

In this step, we’ll install a sample application into the system. This application is included in Istio itself for demonstrating various aspects of it, but the application isn’t tied exclusively to Istio - it’s an ordinary microservice application that could be installed to any OpenShift instance with or without Istio.

The sample application is called _Bookinfo_, a simple application that displays information about a book, similar to a single catalog entry of an online book store. Displayed on the page is a description of the book, book details (ISBN, number of pages, and so on), and a few book reviews.

The BookInfo application is broken into four separate microservices:

* *productpage* - The _productpage_ microservice calls the _details_ and _reviews_ microservices to populate the page.
* *details* - The _details_ microservice contains book information.
* *reviews* - The _reviews_ microservice contains book reviews. It also calls the _ratings_ microservice to show a _star_ rating for each book.
* *ratings* - The _ratings_ microservice contains book rating information that accompanies a book review.

There are 3 versions of the reviews microservice:

* Version *v1* does not call the ratings service.
* Version *v2* calls the ratings service, and displays each rating as 1 to 5 *black* stars.
* Version *v3* calls the ratings service, and displays each rating as 1 to 5 *red* stars.

The end-to-end architecture of the application is shown below.

image::istio_bookinfo.png[Bookinfo Architecture, 700]

First, open a new browser with the link:{{ CONSOLE_URL }}[OpenShift web console, window=_blank]

image::openshift_login.png[openshift_login, 700]

Login using:

* Username: `{{ USER_ID }}`
* Password: `r3dh4t1!`

[IMPORTANT]
====
When you access the link:{{ CONSOLE_URL }}[OpenShift web console] or other URLs via _HTTPS_ protocol, you will see browser warnings like `Your Connection is not secure` since this workshop uses self-signed certificates (which you should not do in production!). For example, if you’re using *Chrome*, to accept the warning, Click on
`Advanced` then `Proceed to...` to access the page.
====

image::browser_warning.png[warning, 700]

Other browsers have similar procedures to accept the security exception.

You will see a list of projects to which you have access:

image::openshift_landing.png[openshift_landing, 700]


The project displayed in the landing page depends on which labs you will run today. 

Although your CodeReady workspace is running on the Kubernetes cluster, it’s running with a default restricted _Service Account_ that prevents you from creating most resource types. If you’ve completed other modules, you’re probably already logged in, but let’s login again. Open a Terminal and issue the following command:

[source,sh,role="copypaste"]
----
oc login https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_SERVICE_PORT --insecure-skip-tls-verify=true
----

Enter your username and password assigned to you:

* Username: `{{ USER_ID }}`
* Password: `r3dh4t1!`

You should see something like this (the project names may be different):

[source,none]
----
Login successful.

You have access to the following projects and can switch between them with 'oc project <projectname>':

  * {{ USER_ID }}-bookinfo
    {{ USER_ID }}-catalog
    {{ USER_ID }}-inventory
    {{ USER_ID }}-istio-system

Using project "{{ USER_ID }}-bookinfo".
Welcome! See 'oc help' to get started.
----

Before we start depoying our application we need to make sure we have the right access to our different application namespaces. The *OpenShift Service Mesh* that includes Elasticsearch, Jaeger, Kiali and Service Mesh Operators, have all been installed at the cluster provisioning time. However for applications to communicate to each other accross different namespaces, we need to ensure that the *ServiceMeshMemberRole* is also created. We create the ServiceMeshMemberRole with the following yaml file

Visit on the {{ CONSOLE_URL }}/topology/ns/{{ USER_ID }}-bookinfo[Topology View, window=_blank], click on `+` icon on the right top corner.

image::plus-icon.png[bookinfo, 500]

Copy the following `ServiceMeshMemberRole` in `YAML` editor then click on *Create*:

[source,sh,role="copypaste"]
----
apiVersion: maistra.io/v1
kind: ServiceMeshMemberRoll
metadata:
  name: default
  namespace: {{ USER_ID }}-istio-system 
spec:
  members:
    - {{ USER_ID }}-bookinfo 
    - {{ USER_ID }}-catalog
    - {{ USER_ID }}-inventory
----

Deploy the *Bookinfo application* in the bookinfo project in CodeReady Workspaces Terminal:

[source,sh,role="copypaste"]
----
oc project {{ USER_ID }}-bookinfo
oc apply -f /projects/cloud-native-workshop-v2m3-labs/istio/bookinfo.yaml
----

And then create the _ingress gateway_ for Bookinfo:

[source,sh,role="copypaste"]
----
oc apply -f /projects/cloud-native-workshop-v2m3-labs/istio/bookinfo-gateway.yaml
----

Before you can use the Bookinfo application, you have to add default destination rules. 

[source,sh,role="copypaste"]
----
oc apply -f /projects/cloud-native-workshop-v2m3-labs/istio/destination-rule-all.yaml
----

Make sure it’s actually done rolling out. Visit the {{ CONSOLE_URL }}/topology/ns/{{ USER_ID }}-bookinfo[Topology View, window=_blank] for the catalog, and ensure you get the blue circles!

image::bookinfo_topology.png[Bookinfo App, 700]

Finally, access the http://istio-ingressgateway-{{ USER_ID }}-istio-system.{{ ROUTE_SUBDOMAIN}}/productpage[Bookinfo Product Page, window=_blank] and ensure it should look something like:

image::bookinfo.png[Bookinfo App]

Reload the page multiple times. The three different versions of the Reviews service show the star ratings differently - _v1_ shows no stars at all, _v2_ shows black stars, and _v3_ shows red stars:

* *v1*: image::stars-none.png[no stars, 700]
* *v2*: image::stars-black.png[black stars, 700]
* *v3*: image::stars-red.png[red stars, 700]

That’s because there are 3 versions of reviews deployment for our reviews service. Istio’s load-balancer is using a _round-robin_ algorithm to iterate through the 3 instances of this service.

You should now have your OpenShift Pods running and have an _Envoy sidecar_ in each of them alongside the microservice. The microservices are productpage, details, ratings, and reviews. Note that you’ll have three versions of the reviews microservice:

[source,sh,role="copypaste"]
----
oc get pods --selector app=reviews
----

[source,sh]
----
NAME                          READY   STATUS    RESTARTS   AGE
reviews-v1-7754bbd88-dm4s5    2/2     Running   0          12m
reviews-v2-69fd995884-qpddl   2/2     Running   0          12m
reviews-v3-5f9d5bbd8-sz29k    2/2     Running   0          12m
----

Notice that each of the microservices shows *2/2* containers ready for each service (one for the service and one for its sidecar).

Now that we have our application deployed and linked into the Istio service mesh, let’s take a look at the immediate value we can get out of it without touching the application code itself!

*Congratulations!*
